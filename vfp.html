<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>Veneto ‚Äî Laborat√≥rio de Composi√ß√£o v3.1</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Serif:wght@400;700&family=IBM+Plex+Sans:wght@300;400;600&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.321.0/dist/umd/lucide.min.js"></script>

    <style>
        :root {
            --primary: #D97757;
            --background: #F5F5F0;
            --foreground: #1A1A1A;
            --secondary: #E8E8E0;
            --muted: #D0D0C8;
            --border: #C0C0B8;
            --green-salvia: #5A8B7F;
            --white: #FFFFFF;
            --shadow: rgba(0, 0, 0, 0.08);
        }

        * { 
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: none;
        }

        /* HEADER */
        .app-header {
            padding: 1rem 2rem;
            background: var(--white);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 2px 10px var(--shadow);
        }
        
        .app-header h1 { 
            font-family: 'IBM Plex Serif', serif; 
            font-size: 1.2rem; 
            margin: 0; 
            font-weight: 700;
        }
        
        .series-number { 
            font-family: 'Courier Prime', monospace; 
            font-size: 0.7rem; 
            color: var(--primary); 
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* MAIN LAYOUT */
        .lab-main {
            display: grid;
            grid-template-columns: 380px 1fr 340px;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }

        /* PANEL STYLE */
        .panel {
            background: var(--secondary);
            border-right: 1px solid var(--border);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--muted) transparent;
        }
        
        .panel::-webkit-scrollbar {
            width: 6px;
        }
        
        .panel::-webkit-scrollbar-thumb {
            background-color: var(--muted);
            border-radius: 3px;
        }
        
        .panel-right { 
            border-right: none; 
            border-left: 1px solid var(--border); 
            background: var(--white); 
        }

        .control-group { 
            margin-bottom: 1.5rem;
        }
        
        .label-wrap { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            font-size: 0.65rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            margin-bottom: 0.75rem;
            letter-spacing: 0.3px;
        }
        
        .label-wrap span { 
            font-family: 'Courier Prime', monospace; 
            color: var(--primary);
            background: var(--white);
            padding: 0.15rem 0.5rem;
            border-radius: 2px;
            border: 1px solid var(--border);
        }

        input[type="range"] { 
            width: 100%; 
            height: 4px;
            -webkit-appearance: none;
            background: linear-gradient(to right, var(--border) 0%, var(--primary) 100%);
            background-size: var(--fill-percent, 50%) 100%;
            background-repeat: no-repeat;
            outline: none;
            border-radius: 2px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb { 
            -webkit-appearance: none;
            width: 16px; 
            height: 16px; 
            background: var(--foreground); 
            border-radius: 50%; 
            cursor: pointer;
            border: 2px solid var(--white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.1s, background 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            background: var(--primary);
        }

        /* BUTTONS */
        .btn-stack { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 0.5rem;
        }
        
        .v-btn {
            background: var(--white); 
            border: 1px solid var(--border); 
            padding: 0.7rem 0.6rem;
            font-size: 0.65rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            cursor: pointer;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.4rem; 
            transition: all 0.2s ease;
            border-radius: 3px;
            user-select: none;
        }
        
        .v-btn:hover { 
            border-color: var(--primary); 
            color: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(217, 119, 87, 0.1);
        }
        
        .v-btn:active {
            transform: translateY(0);
        }
        
        .v-btn.active { 
            background: var(--foreground); 
            color: white;
            border-color: var(--foreground);
        }
        
        .v-btn.primary { 
            background: var(--primary); 
            color: white; 
            border: none;
            grid-column: span 2;
        }
        
        .v-btn.primary:hover {
            background: #c5694a;
            box-shadow: 0 4px 12px rgba(217, 119, 87, 0.2);
        }

        /* VIEWPORT */
        .viewport { 
            background: var(--background); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .canvas-container {
            position: relative;
            display: inline-block;
        }
        
        canvas { 
            background: white; 
            border: 1px solid var(--border); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.07);
            cursor: crosshair;
            display: block;
            touch-action: none;
        }
        
        .canvas-grid {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .canvas-grid.active {
            opacity: 1;
        }

        /* TABS */
        .tabs-header { 
            display: flex; 
            border-bottom: 1px solid var(--border); 
            margin-bottom: 1.2rem;
        }
        
        .tab-link { 
            padding: 0.6rem 1rem; 
            font-size: 0.65rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            cursor: pointer; 
            opacity: 0.6;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }
        
        .tab-link:hover {
            opacity: 0.8;
        }
        
        .tab-link.active { 
            opacity: 1; 
            border-bottom: 2px solid var(--primary); 
        }
        
        .tab-content { 
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active { 
            display: block; 
        }

        /* METRICS */
        .metric-card { 
            margin-bottom: 1.2rem;
            padding: 0.8rem;
            background: var(--white);
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        
        .metric-info { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            font-family: 'Courier Prime', monospace; 
            font-size: 0.65rem; 
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            font-weight: 600;
            color: var(--foreground);
        }
        
        .metric-value {
            font-weight: 700;
            color: var(--primary);
        }
        
        .metric-bar { 
            height: 4px; 
            background: var(--secondary); 
            width: 100%; 
            position: relative;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .metric-fill { 
            height: 100%; 
            background: var(--green-salvia); 
            position: absolute; 
            top: 0;
            left: 0;
            transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 2px;
        }

        .suggestion-box { 
            background: var(--secondary); 
            padding: 1.2rem; 
            border-radius: 4px; 
            font-size: 0.75rem; 
            line-height: 1.5;
            margin-top: 1rem;
            border-left: 3px solid var(--green-salvia);
            animation: slideIn 0.3s ease;
        }

        /* HISTORY */
        .history-list { 
            display: flex; 
            flex-wrap: wrap;
            gap: 0.5rem;
            max-height: 120px;
            overflow-y: auto;
            padding: 0.5rem;
            background: var(--white);
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        
        .history-item { 
            width: 32px; 
            height: 32px; 
            border: 1px solid var(--border); 
            background: var(--white); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.6rem; 
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
            font-family: 'Courier Prime', monospace;
            font-weight: 700;
        }
        
        .history-item:hover { 
            border-color: var(--primary);
            transform: scale(1.05);
        }
        
        .history-item.active { 
            background: var(--foreground); 
            color: white;
            border-color: var(--foreground);
        }

        /* STATUS INDICATOR */
        .status-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--white);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.6rem;
            font-family: 'Courier Prime', monospace;
            border: 1px solid var(--border);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 10;
        }
        
        .status-indicator.show {
            opacity: 1;
        }

        /* ANIMATIONS */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .lab-main { 
                grid-template-columns: 320px 1fr 300px;
            }
        }
        
        @media (max-width: 1024px) {
            .lab-main { 
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                height: auto;
            }
            
            .panel { 
                height: auto; 
                max-height: 300px;
                border-right: none; 
                border-bottom: 1px solid var(--border);
            }
            
            .viewport {
                min-height: 500px;
            }
        }
        
        @media (max-width: 768px) {
            .app-header {
                padding: 0.8rem 1rem;
                flex-direction: column;
                gap: 0.8rem;
            }
            
            .btn-stack {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <div>
            <span class="series-number">An√°lise Est√©tica ‚Ä¢ v3.1</span>
            <h1>Veneto Lab</h1>
        </div>
        <div class="btn-stack" style="grid-template-columns: repeat(4, auto);">
            <button class="v-btn" onclick="Lab.undo()" title="Desfazer">
                <i data-lucide="undo-2" width="14"></i>
            </button>
            <button class="v-btn" onclick="Lab.redo()" title="Refazer">
                <i data-lucide="redo-2" width="14"></i>
            </button>
            <button class="v-btn" onclick="Lab.exportJSON()" title="Exportar JSON">
                <i data-lucide="download" width="14"></i> JSON
            </button>
            <button class="v-btn active" onclick="Lab.optimize()" title="Otimizar composi√ß√£o">
                <i data-lucide="wand-2" width="14"></i> Otimizar
            </button>
        </div>
    </header>

    <div class="status-indicator" id="statusIndicator"></div>

    <main class="lab-main">
        <aside class="panel">
            <p class="series-number">Configura√ß√£o de Massa</p>
            
            <div class="control-group">
                <div class="label-wrap">
                    Volume de Objetos 
                    <span id="lbl-count">5</span>
                </div>
                <input type="range" id="in-count" min="1" max="30" value="5">
            </div>
            
            <div class="control-group">
                <div class="label-wrap">
                    Satura√ß√£o Crom√°tica 
                    <span id="lbl-sat">80%</span>
                </div>
                <input type="range" id="in-sat" min="0" max="100" value="80">
            </div>

            <div class="control-group">
                <div class="label-wrap">
                    Contraste Tonal 
                    <span id="lbl-lum">50%</span>
                </div>
                <input type="range" id="in-lum" min="0" max="100" value="50">
            </div>

            <p class="series-number">Visualiza√ß√£o Anal√≠tica</p>
            <div class="btn-stack">
                <button class="v-btn active" id="mode-normal" onclick="Lab.setMode('normal')">
                    <i data-lucide="box" width="14"></i> Layout
                </button>
                <button class="v-btn" id="mode-flow" onclick="Lab.setMode('flow')">
                    <i data-lucide="navigation-2" width="14"></i> Fluxo
                </button>
                <button class="v-btn" id="mode-weight" onclick="Lab.setMode('weight')">
                    <i data-lucide="layers" width="14"></i> Peso
                </button>
                <button class="v-btn" id="mode-grid" onclick="Lab.setMode('grid')">
                    <i data-lucide="grid" width="14"></i> Grade
                </button>
            </div>

            <button class="v-btn primary" onclick="Lab.newVariation()">
                <i data-lucide="refresh-cw" width="14"></i> Nova Composi√ß√£o
            </button>

            <p class="series-number">Hist√≥rico de Sess√£o</p>
            <div class="history-list" id="history-container"></div>
        </aside>

        <section class="viewport">
            <div class="canvas-container">
                <canvas id="compositionCanvas"></canvas>
                <canvas id="gridCanvas" class="canvas-grid"></canvas>
            </div>
        </section>

        <aside class="panel panel-right">
            <div class="tabs-header">
                <div class="tab-link active" onclick="Lab.setTab('metrics')">M√©tricas</div>
                <div class="tab-link" onclick="Lab.setTab('tips')">Dicas</div>
                <div class="tab-link" onclick="Lab.setTab('export')">Exportar</div>
            </div>

            <div id="tab-metrics" class="tab-content active">
                <div class="metric-card">
                    <div class="metric-info">
                        <span class="metric-label">Equil√≠brio Est√°tico</span>
                        <span class="metric-value" id="txt-balance">0%</span>
                    </div>
                    <div class="metric-bar">
                        <div class="metric-fill" id="bar-balance"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-info">
                        <span class="metric-label">Hierarquia de Foco</span>
                        <span class="metric-value" id="txt-hierarchy">0%</span>
                    </div>
                    <div class="metric-bar">
                        <div class="metric-fill" id="bar-hierarchy"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-info">
                        <span class="metric-label">Ritmo Espacial</span>
                        <span class="metric-value" id="txt-rhythm">0%</span>
                    </div>
                    <div class="metric-bar">
                        <div class="metric-fill" id="bar-rhythm"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-info">
                        <span class="metric-label">Coes√£o Crom√°tica</span>
                        <span class="metric-value" id="txt-cohesion">0%</span>
                    </div>
                    <div class="metric-bar">
                        <div class="metric-fill" id="bar-cohesion"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-info">
                        <span class="metric-label">Tens√£o Visual</span>
                        <span class="metric-value" id="txt-tension">0%</span>
                    </div>
                    <div class="metric-bar">
                        <div class="metric-fill" id="bar-tension" style="background:var(--primary)"></div>
                    </div>
                </div>

                <div class="suggestion-box" id="suggestion-text">
                    Mova as pe√ßas para iniciar a leitura Gestalt da obra.
                </div>
            </div>

            <div id="tab-tips" class="tab-content">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <strong style="font-size: 0.75rem; color: var(--primary);">Princ√≠pios de Gestalt:</strong>
                        <p style="font-size: 0.75rem; margin-top: 0.3rem;">
                            A mente busca ordem na desordem. Agrupe elementos para criar "Unidades".
                        </p>
                    </div>
                    <div>
                        <strong style="font-size: 0.75rem; color: var(--primary);">Peso Crom√°tico:</strong>
                        <p style="font-size: 0.75rem; margin-top: 0.3rem;">
                            Cores escuras e saturadas (Cobalto, Ferro) pesam mais que tons past√©is.
                        </p>
                    </div>
                    <div>
                        <strong style="font-size: 0.75rem; color: var(--primary);">Regra dos Ter√ßos:</strong>
                        <p style="font-size: 0.75rem; margin-top: 0.3rem;">
                            Coloque o ponto focal nas interse√ß√µes da grade para maior dinamismo.
                        </p>
                    </div>
                </div>
            </div>

            <div id="tab-export" class="tab-content">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button class="v-btn" onclick="Lab.exportJSON()">
                        <i data-lucide="file-json" width="14"></i> Exportar JSON
                    </button>
                    <button class="v-btn" onclick="Lab.exportPNG()">
                        <i data-lucide="image" width="14"></i> Exportar PNG
                    </button>
                    <button class="v-btn" onclick="Lab.copyPermalink()">
                        <i data-lucide="link" width="14"></i> Copiar Link
                    </button>
                    <div style="font-size: 0.7rem; color: var(--muted); margin-top: 1rem;">
                        <p>Exporte sua composi√ß√£o para uso em outros projetos ou compartilhe com outros designers.</p>
                    </div>
                </div>
            </div>
        </aside>
    </main>

<script>
    // M√≥dulo principal encapsulado
    const Lab = (function() {
        'use strict';
        
        // Configura√ß√µes
        const config = {
            canvasId: 'compositionCanvas',
            gridCanvasId: 'gridCanvas',
            glazes: [
                { h: 25, s: 70, l: 45, name: 'Terracota' },
                { h: 160, s: 40, l: 30, name: 'S√°lvia' },
                { h: 210, s: 80, l: 25, name: 'Cobalto' },
                { h: 45, s: 60, l: 60, name: 'Ocre' },
                { h: 0, s: 0, l: 20, name: 'Obsidiana' }
            ],
            maxHistory: 20
        };
        
        // Estado da aplica√ß√£o
        let state = {
            elements: [],
            currentMode: 'normal',
            draggingId: null,
            dragOffset: { x: 0, y: 0 },
            seed: Math.floor(Math.random() * 99999),
            canvasDims: { w: 800, h: 600 },
            history: [],
            historyIndex: -1,
            isDragging: false,
            animationFrame: null
        };
        
        // Refer√™ncias DOM
        let canvas, ctx, gridCanvas, gridCtx;
        
        // Inicializa√ß√£o
        function init() {
            setupCanvases();
            setupEventListeners();
            generateComposition();
            draw();
            lucide.createIcons();
        }
        
        function setupCanvases() {
            canvas = document.getElementById(config.canvasId);
            ctx = canvas.getContext('2d');
            gridCanvas = document.getElementById(config.gridCanvasId);
            gridCtx = gridCanvas.getContext('2d');
            
            resizeCanvases();
        }
        
        function resizeCanvases() {
            const dpr = window.devicePixelRatio || 1;
            const width = Math.min(750, canvas.parentElement.parentElement.clientWidth - 40);
            const height = Math.min(550, canvas.parentElement.parentElement.clientHeight - 40);
            
            state.canvasDims = { w: width, h: height };
            
            // Canvas principal
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            ctx.scale(dpr, dpr);
            
            // Canvas da grade
            gridCanvas.width = width * dpr;
            gridCanvas.height = height * dpr;
            gridCanvas.style.width = width + 'px';
            gridCanvas.style.height = height + 'px';
            gridCtx.scale(dpr, dpr);
            
            drawGrid();
        }
        
        function drawGrid() {
            gridCtx.clearRect(0, 0, state.canvasDims.w, state.canvasDims.h);
            
            gridCtx.strokeStyle = '#D0D0C8';
            gridCtx.setLineDash([5, 5]);
            gridCtx.lineWidth = 1;
            
            // Linhas verticais
            for (let i = 1; i < 3; i++) {
                const x = state.canvasDims.w * i / 3;
                gridCtx.beginPath();
                gridCtx.moveTo(x, 0);
                gridCtx.lineTo(x, state.canvasDims.h);
                gridCtx.stroke();
            }
            
            // Linhas horizontais
            for (let i = 1; i < 3; i++) {
                const y = state.canvasDims.h * i / 3;
                gridCtx.beginPath();
                gridCtx.moveTo(0, y);
                gridCtx.lineTo(state.canvasDims.w, y);
                gridCtx.stroke();
            }
            
            gridCtx.setLineDash([]);
        }
        
        // Gera√ß√£o de n√∫meros pseudoaleat√≥rios
        function random() {
            let t = state.seed += 0x6D2B79F5;
            t = Math.imul(t ^ (t >>> 15), t | 1);
            t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
            return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        }
        
        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }
        
        function generateComposition() {
            const count = parseInt(document.getElementById('in-count').value);
            const satBase = parseInt(document.getElementById('in-sat').value);
            const lumBase = parseInt(document.getElementById('in-lum').value);
            
            state.elements = [];
            const localSeed = state.seed;
            
            for (let i = 0; i < count; i++) {
                const glaze = config.glazes[Math.floor(random() * config.glazes.length)];
                const size = 30 + (random() * 100);
                
                state.elements.push({
                    id: i,
                    x: state.canvasDims.w * 0.2 + (random() * state.canvasDims.w * 0.6),
                    y: state.canvasDims.h * 0.2 + (random() * state.canvasDims.h * 0.6),
                    size,
                    hue: glaze.h + (random() * 20 - 10),
                    sat: clamp(glaze.s + (satBase - 50), 0, 100),
                    lum: clamp(glaze.l + (lumBase - 50), 10, 90),
                    isCircle: random() > 0.5,
                    locked: false,
                    originalSize: size
                });
            }
            
            state.seed = localSeed;
            saveState();
            analyzeComposition();
        }
        
        function analyzeComposition() {
            const W = state.canvasDims.w;
            const H = state.canvasDims.h;
            
            if (state.elements.length === 0) {
                updateUI(50, 50, 50, 50, 50);
                return;
            }
            
            // 1. Equil√≠brio
            let totalMass = 0, sumX = 0, sumY = 0;
            state.elements.forEach(e => {
                const mass = (e.size ** 2) * ((100 - e.lum) / 50);
                totalMass += mass;
                sumX += e.x * mass;
                sumY += e.y * mass;
            });
            
            const cog = { x: sumX / totalMass, y: sumY / totalMass };
            const balance = Math.round(clamp(100 - (Math.hypot(cog.x - W/2, cog.y - H/2) / 2), 0, 100));
            
            // 2. Hierarquia
            let hierarchy = 100;
            if (state.elements.length > 1) {
                const sorted = [...state.elements].sort((a, b) => b.size - a.size);
                hierarchy = Math.round(clamp((sorted[0].size / sorted[1].size - 1) * 100, 0, 100));
            }
            
            // 3. Ritmo
            let rhythm = 50;
            if (state.elements.length > 1) {
                let minDists = state.elements.map(e => {
                    let d = Infinity;
                    state.elements.forEach(o => {
                        if (e.id !== o.id) {
                            d = Math.min(d, Math.hypot(e.x - o.x, e.y - o.y));
                        }
                    });
                    return d === Infinity ? 0 : d;
                });
                const avgDist = minDists.reduce((a, b) => a + b, 0) / state.elements.length;
                rhythm = Math.round(clamp(avgDist / 2, 0, 100));
            }
            
            // 4. Coes√£o Crom√°tica
            let cohesion = 50;
            if (state.elements.length > 0) {
                const hues = state.elements.map(e => e.hue);
                const hueSpread = Math.max(...hues) - Math.min(...hues);
                cohesion = Math.round(Math.max(0, 100 - (hueSpread / 3.6)));
            }
            
            // 5. Tens√£o
            const tension = Math.round(((100 - balance) + (100 - rhythm)) / 2);
            
            updateUI(balance, hierarchy, rhythm, cohesion, tension);
        }
        
        function updateUI(bal, hie, rhy, coh, ten) {
            // Atualizar textos e barras
            const metrics = [
                { id: 'balance', value: bal },
                { id: 'hierarchy', value: hie },
                { id: 'rhythm', value: rhy },
                { id: 'cohesion', value: coh },
                { id: 'tension', value: ten }
            ];
            
            metrics.forEach(metric => {
                document.getElementById(`txt-${metric.id}`).innerText = `${metric.value}%`;
                document.getElementById(`bar-${metric.id}`).style.width = `${metric.value}%`;
            });
            
            // Atualizar sugest√£o
            let suggestion = "Composi√ß√£o est√°vel e equilibrada.";
            
            if (bal < 40) {
                suggestion = "O peso pende para as bordas. Tente centralizar a massa maior.";
            } else if (ten > 70) {
                suggestion = "Alta tens√£o visual detectada. Considere simplificar o ritmo ou ajustar o equil√≠brio.";
            } else if (coh < 30) {
                suggestion = "Conflito crom√°tico. Tente aproximar as cores dos objetos ou usar uma paleta mais coesa.";
            } else if (hie < 30) {
                suggestion = "Hierarquia indefinida. Destaque um elemento principal aumentando seu tamanho ou contraste.";
            } else if (rhy < 30) {
                suggestion = "Ritmo espacial irregular. Distribua os elementos de forma mais harmoniosa.";
            }
            
            document.getElementById('suggestion-text').innerText = suggestion;
            
            // Atualizar sliders
            updateSliderBackground('in-sat');
            updateSliderBackground('in-lum');
        }
        
        function updateSliderBackground(sliderId) {
            const slider = document.getElementById(sliderId);
            const value = parseInt(slider.value);
            slider.style.backgroundSize = `${value}% 100%`;
        }
        
        function draw() {
            if (state.animationFrame) {
                cancelAnimationFrame(state.animationFrame);
            }
            
            state.animationFrame = requestAnimationFrame(() => {
                ctx.clearRect(0, 0, state.canvasDims.w, state.canvasDims.h);
                
                // Desenhar elementos
                state.elements.forEach(e => {
                    drawElement(e);
                });
                
                // Desenhar overlay baseado no modo
                drawOverlay();
                
                state.animationFrame = null;
            });
        }
        
        function drawElement(element) {
            ctx.save();
            ctx.translate(element.x, element.y);
            
            // Desenhar halo de peso (modo weight)
            if (state.currentMode === 'weight') {
                const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, element.size * 1.5);
                gradient.addColorStop(0, `hsla(${element.hue}, ${element.sat}%, ${element.lum}%, 0.3)`);
                gradient.addColorStop(1, 'transparent');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(0, 0, element.size * 1.5, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Desenhar forma principal
            ctx.fillStyle = `hsl(${element.hue}, ${element.sat}%, ${element.lum}%)`;
            ctx.beginPath();
            
            if (element.isCircle) {
                ctx.arc(0, 0, element.size / 2, 0, Math.PI * 2);
            } else {
                ctx.rect(-element.size / 2, -element.size / 2, element.size, element.size);
            }
            
            ctx.fill();
            
            // Borda para elementos bloqueados
            if (element.locked) {
                ctx.strokeStyle = 'var(--foreground)';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // √çcone de cadeado
                ctx.fillStyle = 'var(--white)';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üîí', 0, 0);
            }
            
            ctx.restore();
        }
        
        function drawOverlay() {
            if (state.currentMode === 'flow' && state.elements.length > 1) {
                const sorted = [...state.elements].sort((a, b) => b.size - a.size);
                
                ctx.strokeStyle = 'var(--primary)';
                ctx.setLineDash([10, 5]);
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(sorted[0].x, sorted[0].y);
                
                for (let i = 1; i < Math.min(state.elements.length, 5); i++) {
                    ctx.lineTo(sorted[i].x, sorted[i].y);
                }
                
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }
        
        // Gerenciamento de estado
        function saveState() {
            const serialized = JSON.stringify(state.elements);
            
            if (state.historyIndex < state.history.length - 1) {
                state.history = state.history.slice(0, state.historyIndex + 1);
            }
            
            state.history.push(serialized);
            
            if (state.history.length > config.maxHistory) {
                state.history.shift();
            }
            
            state.historyIndex = state.history.length - 1;
            updateHistoryUI();
        }
        
        function updateHistoryUI() {
            const container = document.getElementById('history-container');
            container.innerHTML = '';
            
            state.history.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item' + (index === state.historyIndex ? ' active' : '');
                historyItem.innerText = index + 1;
                historyItem.title = `Composi√ß√£o ${index + 1}`;
                historyItem.onclick = () => loadHistoryState(index);
                container.appendChild(historyItem);
            });
            
            // Rolar para o final
            container.scrollTop = container.scrollHeight;
        }
        
        function loadHistoryState(index) {
            state.historyIndex = index;
            state.elements = JSON.parse(state.history[index]);
            analyzeComposition();
            draw();
        }
        
        // Intera√ß√µes
        function handleMouseDown(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Encontrar elemento clicado
            const clickedElement = state.elements.find(el => 
                Math.hypot(el.x - x, el.y - y) < el.size / 2
            );
            
            if (clickedElement) {
                state.draggingId = clickedElement.id;
                state.dragOffset = { x: x - clickedElement.x, y: y - clickedElement.y };
                state.isDragging = true;
                
                // Feedback visual
                showStatus(`Movendo ${clickedElement.isCircle ? 'c√≠rculo' : 'quadrado'}`);
            }
        }
        
        function handleMouseMove(e) {
            if (state.draggingId === null || !state.isDragging) return;
            
            const rect = canvas.getBoundingClientRect();
            const element = state.elements.find(e => e.id === state.draggingId);
            
            if (!element || element.locked) return;
            
            element.x = e.clientX - rect.left - state.dragOffset.x;
            element.y = e.clientY - rect.top - state.dragOffset.y;
            
            // Manter dentro dos limites
            element.x = clamp(element.x, element.size / 2, state.canvasDims.w - element.size / 2);
            element.y = clamp(element.y, element.size / 2, state.canvasDims.h - element.size / 2);
            
            analyzeComposition();
            draw();
        }
        
        function handleMouseUp() {
            if (state.isDragging) {
                state.isDragging = false;
                saveState();
                showStatus('Posi√ß√£o atualizada', 1000);
            }
            state.draggingId = null;
        }
        
        function handleDoubleClick(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const clickedElement = state.elements.find(el => 
                Math.hypot(el.x - x, el.y - y) < el.size / 2
            );
            
            if (clickedElement) {
                clickedElement.locked = !clickedElement.locked;
                showStatus(
                    clickedElement.locked ? 'Elemento bloqueado' : 'Elemento desbloqueado',
                    1000
                );
                analyzeComposition();
                draw();
            }
        }
        
        function setupEventListeners() {
            // Canvas interactions
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                handleMouseDown(touch);
            }, { passive: false });
            
            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                handleMouseMove(touch);
            }, { passive: false });
            
            window.addEventListener('mouseup', handleMouseUp);
            window.addEventListener('touchend', handleMouseUp);
            
            canvas.addEventListener('dblclick', handleDoubleClick);
            
            // Sliders
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                slider.addEventListener('input', handleSliderChange);
                updateSliderBackground(slider.id);
            });
            
            // Window resize
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    resizeCanvases();
                    draw();
                    analyzeComposition();
                }, 200);
            });
        }
        
        function handleSliderChange(e) {
            const id = e.target.id.split('-')[1];
            const value = e.target.value;
            
            document.getElementById(`lbl-${id}`).innerText = 
                id === 'count' ? value : `${value}%`;
            
            updateSliderBackground(e.target.id);
            
            // Debounce para evitar m√∫ltiplas gera√ß√µes
            clearTimeout(this.debounce);
            this.debounce = setTimeout(() => {
                generateComposition();
                draw();
            }, 150);
        }
        
        // Fun√ß√µes p√∫blicas
        function undo() {
            if (state.historyIndex > 0) {
                state.historyIndex--;
                state.elements = JSON.parse(state.history[state.historyIndex]);
                analyzeComposition();
                draw();
                showStatus('Desfeito', 1000);
            }
        }
        
        function redo() {
            if (state.historyIndex < state.history.length - 1) {
                state.historyIndex++;
                state.elements = JSON.parse(state.history[state.historyIndex]);
                analyzeComposition();
                draw();
                showStatus('Refeito', 1000);
            }
        }
        
        function optimize() {
            const btn = document.getElementById('btn-optimize');
            const originalText = btn.innerHTML;
            
            // Feedback visual
            btn.innerHTML = '<i data-lucide="loader" width="14" class="spin"></i> Processando';
            btn.disabled = true;
            
            setTimeout(() => {
                state.elements.forEach(e => {
                    if (!e.locked) {
                        e.x = (e.x + state.canvasDims.w / 2) / 2;
                        e.y = (e.y + state.canvasDims.h / 2) / 2;
                    }
                });
                
                saveState();
                analyzeComposition();
                draw();
                
                // Restaurar bot√£o
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                showStatus('Composi√ß√£o otimizada', 1500);
                lucide.createIcons();
            }, 300);
        }
        
        function exportJSON() {
            const data = {
                version: '3.1',
                seed: state.seed,
                timestamp: new Date().toISOString(),
                elements: state.elements,
                canvasDimensions: state.canvasDims,
                metrics: {
                    balance: document.getElementById('txt-balance').innerText,
                    hierarchy: document.getElementById('txt-hierarchy').innerText,
                    rhythm: document.getElementById('txt-rhythm').innerText,
                    cohesion: document.getElementById('txt-cohesion').innerText,
                    tension: document.getElementById('txt-tension').innerText
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `veneto-composition-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('JSON exportado', 1500);
        }
        
        function exportPNG() {
            const originalMode = state.currentMode;
            setMode('normal');
            
            setTimeout(() => {
                const link = document.createElement('a');
                link.download = `veneto-composition-${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus('PNG exportado', 1500);
            }, 100);
        }
        
        function copyPermalink() {
            const stateData = {
                seed: state.seed,
                elements: state.elements.map(e => ({
                    x: Math.round(e.x),
                    y: Math.round(e.y),
                    size: Math.round(e.size),
                    hue: Math.round(e.hue),
                    sat: Math.round(e.sat),
                    lum: Math.round(e.lum),
                    isCircle: e.isCircle,
                    locked: e.locked
                }))
            };
            
            const encoded = btoa(JSON.stringify(stateData));
            const url = `${window.location.origin}${window.location.pathname}#${encoded}`;
            
            navigator.clipboard.writeText(url).then(() => {
                showStatus('Link copiado para a √°rea de transfer√™ncia', 2000);
            });
        }
        
        function setMode(mode) {
            state.currentMode = mode;
            
            // Atualizar bot√µes
            document.querySelectorAll('.btn-stack .v-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`mode-${mode}`).classList.add('active');
            
            // Mostrar/ocultar grade
            const gridCanvas = document.getElementById('gridCanvas');
            if (mode === 'grid') {
                gridCanvas.classList.add('active');
            } else {
                gridCanvas.classList.remove('active');
            }
            
            draw();
        }
        
        function setTab(tab) {
            document.querySelectorAll('.tab-link, .tab-content').forEach(el => {
                el.classList.remove('active');
            });
            
            document.querySelector(`.tab-link[onclick*="${tab}"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }
        
        function newVariation() {
            state.seed = Math.floor(Math.random() * 99999);
            generateComposition();
            draw();
            showStatus('Nova composi√ß√£o gerada', 1500);
        }
        
        function showStatus(message, duration = 2000) {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = message;
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, duration);
        }
        
        // Adicionar estilo para anima√ß√£o de spin
        const style = document.createElement('style');
        style.textContent = `
            .spin {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
        
        // Inicializar quando o DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        // Retornar API p√∫blica
        return {
            undo,
            redo,
            optimize,
            exportJSON,
            exportPNG,
            copyPermalink,
            setMode,
            setTab,
            newVariation,
            init
        };
    })();
</script>

</body>
</html>
